---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const events = await getCollection('events');
  return events.map(event => ({
    params: { slug: event.slug },
    props: { event },
  }));
}

const { event } = Astro.props;
const { Content } = await render(event);

// Get event ID (strip /index suffix if present)
const eventId = event.id.replace('/index', '').replace('.md', '');

// Scan public/events directory for files
const publicDir = path.join(process.cwd(), 'public', 'events', eventId);
let files: { name: string; type: 'image' | 'pdf' | 'other'; url: string }[] = [];

try {
  if (fs.existsSync(publicDir)) {
    const entries = fs.readdirSync(publicDir);
    files = entries
      .filter(f => {
        // Exclude cover images, .orig files, and geojson
        if (f.startsWith('cover.')) return false;
        if (f.endsWith('.orig')) return false;
        if (f.endsWith('.geojson')) return false;
        return true;
      })
      .map(f => {
        const ext = path.extname(f).toLowerCase();
        let type: 'image' | 'pdf' | 'other' = 'other';
        if (['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(ext)) {
          type = 'image';
        } else if (ext === '.pdf') {
          type = 'pdf';
        }
        return {
          name: f.replace(/_/g, ' ').replace(/\.[^.]+$/, ''),
          type,
          url: `/events/${eventId}/${f}`,
        };
      })
      .sort((a, b) => a.name.localeCompare(b.name));
  }
} catch (e) {
  // No files directory
}
---

<Layout title={`${event.data.title} - Hulme History`}>
  <article class="event-page">
    <header>
      <time>{event.data.start}{event.data.end ? ` - ${event.data.end}` : ''}</time>
      <h1>{event.data.title}</h1>
      {event.data.desc && <p class="desc">{event.data.desc}</p>}
      {event.data.author && <p class="author">By {event.data.author}</p>}
    </header>
    <div class="content">
      <Content />
    </div>

    {files.length > 0 && (
      <section class="gallery" data-files={JSON.stringify(files)}>
        <h3>Documents & Images</h3>
        <div class="gallery-grid">
          {files.map(file => (
            <a
              href={file.url}
              class={`gallery-item ${file.type}`}
              data-type={file.type}
              target={file.type === 'pdf' ? '_blank' : undefined}
            >
              {file.type === 'image' ? (
                <img src={file.url} alt={file.name} loading="lazy" />
              ) : (
                <div class="file-icon">
                  <span class="icon">{file.type === 'pdf' ? 'üìÑ' : 'üìÅ'}</span>
                </div>
              )}
              <span class="file-name">{file.name}</span>
            </a>
          ))}
        </div>
      </section>
    )}

    <footer>
      <a href="/">&larr; Back to Map</a>
    </footer>
  </article>
</Layout>

<style>
  .event-page {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ddd;
  }

  time {
    display: block;
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .desc {
    font-size: 1.1rem;
    color: #555;
    margin-bottom: 0.5rem;
  }

  .author {
    font-size: 0.9rem;
    color: #888;
    font-style: italic;
  }

  .content {
    line-height: 1.7;
  }

  .content :global(p) {
    margin-bottom: 1em;
  }

  .content :global(blockquote) {
    border-left: 3px solid #ddd;
    padding-left: 1rem;
    margin: 1.5em 0;
    color: #555;
    font-style: italic;
  }

  .content :global(ul), .content :global(ol) {
    margin-bottom: 1em;
    padding-left: 1.5em;
  }

  footer {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
  }

  footer a {
    color: var(--color-buildings);
    text-decoration: none;
  }

  footer a:hover {
    text-decoration: underline;
  }

  .gallery {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #ddd;
  }

  .gallery h3 {
    font-size: 1.1rem;
    color: #555;
    margin-bottom: 1rem;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
  }

  .gallery-item {
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    border-radius: 6px;
    overflow: hidden;
    background: #f5f5f5;
    transition: transform 0.15s, box-shadow 0.15s;
  }

  .gallery-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .gallery-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
  }

  .gallery-item .file-icon {
    width: 100%;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e8e8e8;
  }

  .gallery-item .icon {
    font-size: 2.5rem;
  }

  .gallery-item .file-name {
    padding: 8px;
    font-size: 0.75rem;
    line-height: 1.3;
    color: #444;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  /* Lightbox styles */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 4px;
  }

  .lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    border-radius: 50%;
    transition: background 0.15s;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    border-radius: 50%;
    transition: background 0.15s;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .lightbox-prev { left: 20px; }
  .lightbox-next { right: 20px; }

  .lightbox-caption {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 0.9rem;
    text-align: center;
    padding: 8px 16px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    max-width: 80%;
  }
</style>

<div id="lightbox" class="lightbox">
  <button class="lightbox-close">&times;</button>
  <button class="lightbox-nav lightbox-prev">&larr;</button>
  <img src="" alt="" />
  <button class="lightbox-nav lightbox-next">&rarr;</button>
  <div class="lightbox-caption"></div>
</div>

<script>
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = lightbox?.querySelector('img');
  const lightboxCaption = lightbox?.querySelector('.lightbox-caption');
  const closeBtn = lightbox?.querySelector('.lightbox-close');
  const prevBtn = lightbox?.querySelector('.lightbox-prev');
  const nextBtn = lightbox?.querySelector('.lightbox-next');

  let images: { url: string; name: string }[] = [];
  let currentIndex = 0;

  // Get all image gallery items
  document.querySelectorAll('.gallery-item.image').forEach((item, index) => {
    const img = item.querySelector('img');
    const name = item.querySelector('.file-name')?.textContent || '';
    if (img) {
      images.push({ url: img.src, name });
    }

    item.addEventListener('click', (e) => {
      e.preventDefault();
      currentIndex = index;
      showImage(currentIndex);
      lightbox?.classList.add('active');
    });
  });

  function showImage(index: number) {
    if (lightboxImg && lightboxCaption && images[index]) {
      lightboxImg.src = images[index].url;
      lightboxCaption.textContent = images[index].name;
    }
  }

  closeBtn?.addEventListener('click', () => {
    lightbox?.classList.remove('active');
  });

  prevBtn?.addEventListener('click', () => {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showImage(currentIndex);
  });

  nextBtn?.addEventListener('click', () => {
    currentIndex = (currentIndex + 1) % images.length;
    showImage(currentIndex);
  });

  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) {
      lightbox.classList.remove('active');
    }
  });

  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('active')) return;
    if (e.key === 'Escape') lightbox.classList.remove('active');
    if (e.key === 'ArrowLeft') {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      showImage(currentIndex);
    }
    if (e.key === 'ArrowRight') {
      currentIndex = (currentIndex + 1) % images.length;
      showImage(currentIndex);
    }
  });
</script>
